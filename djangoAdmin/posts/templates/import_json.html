{% extends "admin/base_site.html" %} {% load static %} {% block content %}
<h1>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (JSON)</h1>

<form id="importForm" enctype="multipart/form-data" method="post">
  {% csrf_token %}
  <div style="margin-bottom: 1rem">
    <label for="id_json_file">–í—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª:</label><br />
    <input
      type="file"
      name="json_file"
      id="id_json_file"
      accept=".json"
      required
      style="margin-top: 5px"
    />
  </div>

  <button
    type="submit"
    class="default"
    id="startButton"
    style="color: white; border: none; padding: 8px 16px; border-radius: 4px"
  >
    –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
  </button>
  <a
    href="{% url 'admin:index' %}"
    class="button cancel-link"
    style="margin-left: 10px"
  >
    –û—Ç–º–µ–Ω–∞
  </a>
</form>

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
<div id="progressContainer" style="display: none; margin-top: 2rem">
  <h3>üìä –°—Ç–∞—Ç—É—Å –∏–º–ø–æ—Ä—Ç–∞</h3>
  <p>–°—Ç–∞—Ç—É—Å: <span id="statusText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span></p>
  <progress
    id="progressBar"
    value="0"
    max="100"
    style="width: 100%; height: 20px"
  ></progress>
  <p><span id="progressValue">0%</span> –∑–∞–≤–µ—Ä—à–µ–Ω–æ</p>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="resultContainer" style="display: none; margin-top: 1.5rem">
  <h3>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
  <p id="resultMessage"></p>
  <a
    href="{% url 'admin:posts_transactions_changelist' %}"
    class="button default"
    style="
      background-color: #28a745;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
    "
  >
    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
  </a>
</div>

<script>
  document
    .getElementById("importForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("id_json_file");
      if (!fileInput.files.length) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ JSON-—Ñ–∞–π–ª!");
        return;
      }

      // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      document.getElementById("startButton").disabled = true;
      document.getElementById("progressContainer").style.display = "block";

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç
      const startRes = await fetch("/api/import/start/", {
        method: "POST",
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: formData,
      });

      const startData = await startRes.json();
      if (!startData.task_id) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + (startData.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
        document.getElementById("startButton").disabled = false;
        return;
      }

      const taskId = startData.task_id;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      const checkProgress = async () => {
        const resp = await fetch(`/api/import/progress/${taskId}/`);
        const data = await resp.json();

        if (data.error) {
          document.getElementById("statusText").textContent = "–û—à–∏–±–∫–∞";
          document.getElementById("resultMessage").textContent = data.error;
          document.getElementById("resultContainer").style.display = "block";
          return;
        }

        document.getElementById("statusText").textContent = data.status;
        document.getElementById("progressBar").value = data.progress;
        document.getElementById("progressValue").textContent =
          data.progress + "%";

        if (data.status === "completed" || data.status === "failed") {
          document.getElementById("resultContainer").style.display = "block";
          document.getElementById("resultMessage").textContent = data.message;
          return;
        }

        setTimeout(checkProgress, 1500);
      };

      checkProgress();
    });
</script>
{% endblock %}
